{% load static %}
<div class="flex justify-between items-center px-1 sm:px-0">
    <button id="newLeaveBtn" class="px-4 py-2 text-white bg-blue-500 rounded-md transition-colors duration-200 dark:bg-blue-600 hover:bg-blue-600 dark:hover:bg-blue-700">
        Request Leave
    </button>
    <!-- Theme Toggle with animation -->
    <button data-theme-toggle id="themeToggle" class="relative p-2 text-gray-700 rounded-lg transition-all duration-300 dark:text-gray-200 group hover:scale-110">
        <div class="absolute inset-0 rounded-lg opacity-0 transition-opacity duration-300 bg-coral group-hover:opacity-20"></div>
        <svg class="w-6 h-6 transition-transform duration-300 transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path class="sun-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            <path class="hidden moon-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>
</div>

<!-- Leave Request Modal -->
<div id="leaveRequestModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div id="modalContent" class="relative bg-white rounded-lg max-w-lg w-full dark:bg-gray-800">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Request Leave</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <form id="leaveRequestForm" class="p-6">
                <div class="space-y-4">
                    <!-- Leave Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Leave Type</label>
                        <select name="leaveType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select type</option>
                            <option value="vacation">Vacation</option>
                            <option value="sick">Sick Leave</option>
                            <option value="personal">Personal</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                            <input type="date" name="startDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label>
                            <input type="date" name="endDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Reason</label>
                        <textarea name="reason" required rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Please provide a reason for your leave request"></textarea>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden p-3 text-sm text-red-600 bg-red-100 rounded-md dark:bg-red-900 dark:text-red-200"></div>
                </div>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelLeaveRequest" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Theme toggle functionality
    const themeToggleBtn = document.getElementById('themeToggle');
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    const dropdown = document.getElementById('userDropdown');
    const dropdownBtn = document.getElementById('dropdownBtn');

    // Theme toggle logic
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            sunIcon.classList.toggle('hidden');
            moonIcon.classList.toggle('hidden');
        });
    }

    // Dropdown logic
    if (dropdownBtn && dropdown) {
        dropdownBtn.addEventListener('click', function() {
            const isHidden = dropdown.classList.contains('scale-0');
            if (!isHidden) {
                dropdown.classList.remove('transform', 'scale-100', 'opacity-100');
                dropdown.classList.add('transform', 'scale-0', 'opacity-0');
            } else {
                dropdown.classList.remove('transform', 'scale-0', 'opacity-0');
                dropdown.classList.add('transform', 'scale-100', 'opacity-100');
            }
        });
    }

    // Leave modal functionality
    const modal = document.getElementById('leaveRequestModal');
    const modalContent = document.getElementById('modalContent');
    const newLeaveBtn = document.getElementById('newLeaveBtn');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelLeaveRequest');
    const form = document.getElementById('leaveRequestForm');
    const errorMessage = document.getElementById('errorMessage');

    function showModal() {
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    function hideModal() {
        if (modal) {
            modal.classList.add('hidden');
        }
        if (form) {
            form.reset();
        }
        if (errorMessage) {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
        }
    }

    function validateDates(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (start < today) {
            return "Start date cannot be in the past";
        }
        if (end < start) {
            return "End date must be after or equal to start date";
        }
        return "";
    }

    // Event Listeners
    if (newLeaveBtn) {
        newLeaveBtn.addEventListener('click', showModal);
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', hideModal);
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', hideModal);
    }

    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideModal();
            }
        });
    }

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');
            const reason = formData.get('reason');
            
            // Validate dates
            const dateError = validateDates(startDate, endDate);
            if (dateError && errorMessage) {
                errorMessage.textContent = dateError;
                errorMessage.classList.remove('hidden');
                return;
            }

            // Validate reason length
            if (reason.length < 10 && errorMessage) {
                errorMessage.textContent = "Please provide a more detailed reason (at least 10 characters)";
                errorMessage.classList.remove('hidden');
                return;
            }

            // If all validations pass, submit the form
            console.log('Form submitted:', Object.fromEntries(formData));
            hideModal();
        });

        // Set minimum date for date inputs
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = form.querySelector('input[name="startDate"]');
        const endDateInput = form.querySelector('input[name="endDate"]');

        if (startDateInput) {
            startDateInput.min = today;
            startDateInput.addEventListener('change', function() {
                if (endDateInput) {
                    endDateInput.min = this.value;
                }
            });
        }

        if (endDateInput) {
            endDateInput.min = today;
        }
    }
});
</script>